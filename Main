import os
import json
import time
import requests
from fastapi import FastAPI, Request
from fastapi.responses import PlainTextResponse

# ==============================
#  ENV & CONFIG
# ==============================
BOT_TOKEN = os.getenv("BOT_TOKEN")
GIST_ID = os.getenv("GIST_ID")
GIST_TOKEN = os.getenv("GIST_TOKEN")

# CÃ³ thá»ƒ dÃ¹ng env hoáº·c giá»¯ máº·c Ä‘á»‹nh 5816758036
_admin_env = os.getenv("ADMIN_CHAT_ID")
if _admin_env:
    try:
        ADMIN_CHAT_ID = int(_admin_env)
    except ValueError:
        ADMIN_CHAT_ID = 5816758036
else:
    ADMIN_CHAT_ID = 5816758036

CLOUD_RUN_URL = os.getenv("CLOUD_RUN_SERVICE_URL", "")

WEBHOOK_PATH = "/webhook"
WEBHOOK_URL = f"{CLOUD_RUN_URL}{WEBHOOK_PATH}" if CLOUD_RUN_URL else WEBHOOK_PATH

TG_BASE_URL = f"https://api.telegram.org/bot{BOT_TOKEN}"

GIST_URL = f"https://api.github.com/gists/{GIST_ID}"
GIST_HEADERS = {
    "Authorization": f"token {GIST_TOKEN}",
    "Accept": "application/vnd.github.v3+json",
}

# Cáº¥u hÃ¬nh VietQR
BANK_ID = "970436"                 # vÃ­ dá»¥: MB Bank
ACCOUNT_NUMBER = "0711000283429"   # THAY báº±ng STK cá»§a báº¡n

# GiÃ¡ má»—i gÃ³i
PACKAGE_PRICES = {
    "GO":   {"shop": 50000,  "own": 70000},
    "PLUS": {"shop": 100000, "own": 130000},
    "TEAM": {"shop": 200000, "own": 260000},
    "EDU":  {"shop": 80000},  # EDU chá»‰ shop cáº¥p
}

# File trong Gist
FREE_ACCOUNTS_FILE = "free_accounts.json"
SHOP_ACCOUNTS_FILE = "shop_accounts.json"
PENDING_ORDERS_FILE = "pending_orders.json"
FREE_CLAIMS_FILE = "free_claims.json"
# Tráº¡ng thÃ¡i táº¡m theo user
# { user_id: {"awaiting_info": package, "account_type": "shop|own", "payment_code": str} }
USER_STATE = {}


# ==============================
#  GIST HELPERS
# ==============================
def load_gist_json(filename: str) -> dict:
    try:
        r = requests.get(GIST_URL, headers=GIST_HEADERS, timeout=10)
        gist = r.json()
        files = gist.get("files", {})
        content = files.get(filename, {}).get("content", "{}")
        return json.loads(content)
    except Exception as e:
        print(f"GIST READ ERR ({filename}):", e)
        return {}


def save_gist_json(filename: str, data: dict) -> None:
    try:
        payload = {
            "files": {
                filename: {
                    "content": json.dumps(data, indent=4, ensure_ascii=False)
                }
            }
        }
        requests.patch(GIST_URL, headers=GIST_HEADERS, json=payload, timeout=10)
    except Exception as e:
        print(f"GIST WRITE ERR ({filename}):", e)


def save_user_to_gist(user_id: int) -> None:
    users = load_gist_json("users.json")
    if str(user_id) not in users:
        users[str(user_id)] = {"joined": True, "joined_at": int(time.time())}
        save_gist_json("users.json", users)


def save_order_to_gist(user_id: int, data: dict) -> None:
    orders = load_gist_json("orders.json")
    orders[str(user_id)] = data
    save_gist_json("orders.json", orders)
def has_claimed_free(user_id: int, package: str) -> bool:
    """
    Kiá»ƒm tra user Ä‘Ã£ nháº­n tÃ i khoáº£n miá»…n phÃ­ / khuyáº¿n mÃ£i cá»§a loáº¡i nÃ y chÆ°a.
    package: tÃªn gÃ³i - vÃ­ dá»¥: "GO", "EDU", "PLUS", "CANVA_EDU", ...
    """
    claims = load_gist_json(FREE_CLAIMS_FILE)
    u = claims.get(str(user_id), {})
    return u.get(package, False)


def mark_claimed_free(user_id: int, package: str) -> None:
    """
    ÄÃ¡nh dáº¥u user Ä‘Ã£ nháº­n 1 tÃ i khoáº£n miá»…n phÃ­ / khuyáº¿n mÃ£i cá»§a loáº¡i nÃ y.
    """
    claims = load_gist_json(FREE_CLAIMS_FILE)
    u = claims.get(str(user_id), {})
    u[package] = True
    claims[str(user_id)] = u
    save_gist_json(FREE_CLAIMS_FILE, claims)


def get_and_consume_account(filename: str, package: str) -> str | None:
    """
    Láº¥y 1 tÃ i khoáº£n tá»« list theo gÃ³i, Ä‘á»“ng thá»i xÃ³a khá»i kho (khÃ´ng cáº¥p trÃ¹ng).
    Gist file dáº¡ng:

    {
      "GO": [
        "user|pass|note",
        "user2|pass2|note"
      ],
      "EDU": [...]
    }
    """
    data = load_gist_json(filename)
    accounts = data.get(package, [])
    if isinstance(accounts, list) and accounts:
        acc = accounts.pop(0)
        data[package] = accounts
        save_gist_json(filename, data)
        return acc
    return None


def create_pending_order(payment_code: str, user_id: int, chat_id: int,
                         username: str, package: str, account_type: str):
    orders = load_gist_json(PENDING_ORDERS_FILE)
    orders[payment_code] = {
        "user_id": user_id,
        "chat_id": chat_id,
        "username": username,
        "package": package,
        "account_type": account_type,
        "status": "waiting_payment",
        "info": "",
        "created_at": int(time.time()),
    }
    save_gist_json(PENDING_ORDERS_FILE, orders)


def update_pending_order_info(payment_code: str, info: str) -> bool:
    orders = load_gist_json(PENDING_ORDERS_FILE)
    if payment_code not in orders:
        return False
    orders[payment_code]["info"] = info
    save_gist_json(PENDING_ORDERS_FILE, orders)
    return True


# ==============================
#  QR HELPER
# ==============================
def generate_qr(package_name: str, account_type: str,
                user_id: int, username: str | None):
    """
    Táº¡o QR VietQR vá»›i addInfo = payment_code
    payment_code = GO-shop-username
    """
    username_slug = username or f"id{user_id}"
    price = PACKAGE_PRICES[package_name][account_type]
    payment_code = f"{package_name}-{account_type}-{username_slug}"

    qr_url = (
        f"https://img.vietqr.io/image/{BANK_ID}-{ACCOUNT_NUMBER}-compact.png"
        f"?amount={price}&addInfo={payment_code}"
    )
    return qr_url, price, payment_code


# ==============================
#  TELEGRAM HELPERS
# ==============================
def tg_send_message(chat_id, text, reply_markup=None, parse_mode=None):
    url = f"{TG_BASE_URL}/sendMessage"
    payload = {"chat_id": chat_id, "text": text}
    if parse_mode:
        payload["parse_mode"] = parse_mode
    if reply_markup:
        payload["reply_markup"] = reply_markup

    try:
        r = requests.post(url, json=payload, timeout=10)
        # LOG Ä‘á»ƒ kiá»ƒm tra viá»‡c gá»­i tin
        print("TG sendMessage:", payload, "â†’", r.status_code, r.text)
    except Exception as e:
        print("sendMessage error:", e)


def tg_send_photo(chat_id, photo_url, caption=None, parse_mode=None, reply_markup=None):
    url = f"{TG_BASE_URL}/sendPhoto"
    payload = {"chat_id": chat_id, "photo": photo_url}
    if caption:
        payload["caption"] = caption
    if parse_mode:
        payload["parse_mode"] = parse_mode
    if reply_markup:
        payload["reply_markup"] = reply_markup
    try:
        r = requests.post(url, json=payload, timeout=10)
        print("TG sendPhoto:", payload, "â†’", r.status_code, r.text)
    except Exception as e:
        print("sendPhoto error:", e)


def tg_answer_callback_query(callback_query_id):
    url = f"{TG_BASE_URL}/answerCallbackQuery"
    try:
        r = requests.post(url, json={"callback_query_id": callback_query_id}, timeout=10)
        print("TG answerCallbackQuery:", r.status_code, r.text)
    except Exception as e:
        print("answerCallbackQuery error:", e)


def tg_edit_message_text(chat_id, message_id, text, reply_markup=None, parse_mode=None):
    url = f"{TG_BASE_URL}/editMessageText"
    payload = {"chat_id": chat_id, "message_id": message_id, "text": text}
    if parse_mode:
        payload["parse_mode"] = parse_mode
    if reply_markup:
        payload["reply_markup"] = reply_markup
    try:
        r = requests.post(url, json=payload, timeout=10)
        print("TG editMessageText:", payload, "â†’", r.status_code, r.text)
    except Exception as e:
        print("editMessageText error:", e)


def send_admin_message(text: str, reply_markup=None):
    """
    Gá»­i tin nháº¯n cho admin.
    KhÃ´ng dÃ¹ng Markdown Ä‘á»ƒ trÃ¡nh lá»—i parse (username cÃ³ dáº¥u _ , v.v.).
    CÃ³ thá»ƒ Ä‘Ã­nh kÃ¨m inline keyboard qua reply_markup.
    """
    if not ADMIN_CHAT_ID:
        print("ADMIN_CHAT_ID not set, skip admin message:", text)
        return
    tg_send_message(ADMIN_CHAT_ID, text, reply_markup=reply_markup, parse_mode=None)



# ==============================
#  UI KEYBOARDS & MENUS
# ==============================
def main_menu_keyboard():
    return {
        "inline_keyboard": [
            [{"text": "ğŸ›’ Mua gÃ³i", "callback_data": "buy"}],
            [{"text": "ğŸ GÃ³i miá»…n phÃ­", "callback_data": "free"}],
        ]
    }


def _package_price_range_label(pkg: str) -> str:
    prices = PACKAGE_PRICES.get(pkg, {})
    vals = list(prices.values())
    if not vals:
        return f"MAIN {pkg}"
    min_p = min(vals)
    max_p = max(vals)
    if min_p == max_p:
        return f"MAIN {pkg} ({min_p}Ä‘)"
    return f"MAIN {pkg} ({min_p}-{max_p}Ä‘)"


def buy_menu_keyboard():
    return {
        "inline_keyboard": [
            [{"text": _package_price_range_label("GO"), "callback_data": "buy_go_main"}],
            [{"text": _package_price_range_label("PLUS"), "callback_data": "buy_plus_main"}],
            [{"text": _package_price_range_label("TEAM"), "callback_data": "buy_team_main"}],
            [{"text": _package_price_range_label("EDU"), "callback_data": "buy_edu_main"}],
            [{"text": "â¬…ï¸ Quay láº¡i", "callback_data": "back_main"}],
        ]
    }


def buy_type_keyboard(package: str):
    prices = PACKAGE_PRICES.get(package, {})
    rows = []
    if "shop" in prices:
        rows.append([{
            "text": f"TK shop cáº¥p - {prices['shop']}Ä‘",
            "callback_data": f"buy_{package.lower()}_shop",
        }])
    if "own" in prices:
        rows.append([{
            "text": f"TK chÃ­nh chá»§ - {prices['own']}Ä‘",
            "callback_data": f"buy_{package.lower()}_own",
        }])
    rows.append([{"text": "â¬…ï¸ Quay láº¡i chá»n gÃ³i", "callback_data": "back_buy"}])
    return {"inline_keyboard": rows}


def free_menu_keyboard():
    return {
        "inline_keyboard": [
            [{"text": "Miá»…n phÃ­ GO", "callback_data": "free_go"}],
            [{"text": "Miá»…n phÃ­ EDU", "callback_data": "free_edu"}],
            [{"text": "Miá»…n phÃ­ PLUS", "callback_data": "free_plus"}],
            [{"text": "Miá»…n phÃ­ Canva EDU", "callback_data": "free_canva_edu"}],   # â† THÃŠM
            [{"text": "â¬…ï¸ Quay láº¡i", "callback_data": "back_main"}],
        ]
    }



def payment_confirm_keyboard():
    return {
        "inline_keyboard": [
            [{"text": "âœ… TÃ´i Ä‘Ã£ chuyá»ƒn khoáº£n", "callback_data": "confirm_paid"}],
        ]
    }

def admin_order_keyboard(payment_code: str):
    """
    Inline keyboard cho admin xá»­ lÃ½ Ä‘Æ¡n theo payment_code.
    """
    return {
        "inline_keyboard": [
            [
                {"text": "âœ… Äá»§ tiá»n", "callback_data": f"adm_ok|{payment_code}"},
            ],
            [
                {"text": "âš ï¸ Chuyá»ƒn thiáº¿u", "callback_data": f"adm_under|{payment_code}"},
                {"text": "ğŸ’¸ Chuyá»ƒn thá»«a", "callback_data": f"adm_over|{payment_code}"},
            ],
            [
                {"text": "âŒ KhÃ´ng tháº¥y tiá»n", "callback_data": f"adm_none|{payment_code}"},
            ],
        ]
    }

def send_main_menu(chat_id):
    text = (
        "ğŸ‰ ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i Bot!\n\n"
        "Báº¡n cÃ³ thá»ƒ:\n"
        "- Mua gÃ³i (GO / PLUS / TEAM / EDU)\n"
        "- Nháº­n gÃ³i miá»…n phÃ­\n"
        "Bot máº«u phá»¥c vá»¥ há»c táº­p."
    )
    tg_send_message(chat_id, text, reply_markup=main_menu_keyboard())


def send_buy_menu(chat_id, message_id=None):
    text = (
        "ğŸ›’ Chá»n gÃ³i MAIN báº¡n muá»‘n mua:\n\n"
        "Má»—i gÃ³i sáº½ cÃ³ 2 lá»±a chá»n:\n"
        "- TÃ i khoáº£n shop cáº¥p\n"
        "- TÃ i khoáº£n chÃ­nh chá»§ (náº¿u cÃ³)\n\n"
        "Báº¥m vÃ o gÃ³i Ä‘á»ƒ xem chi tiáº¿t giÃ¡."
    )
    if message_id:
        tg_edit_message_text(chat_id, message_id, text, reply_markup=buy_menu_keyboard())
    else:
        tg_send_message(chat_id, text, reply_markup=buy_menu_keyboard())


def send_buy_type_menu(chat_id, package: str, message_id=None):
    prices = PACKAGE_PRICES.get(package, {})
    desc_lines = [f"ğŸ“¦ GÃ“I {package}"]
    if "shop" in prices:
        desc_lines.append(f"- TK shop cáº¥p: {prices['shop']}Ä‘")
    if "own" in prices:
        desc_lines.append(f"- TK chÃ­nh chá»§: {prices['own']}Ä‘")
    text = "\n".join(desc_lines)
    if message_id:
        tg_edit_message_text(chat_id, message_id, text,
                             reply_markup=buy_type_keyboard(package))
    else:
        tg_send_message(chat_id, text, reply_markup=buy_type_keyboard(package))


def send_free_menu(chat_id, message_id=None):
    text = (
        "ğŸ Chá»n gÃ³i miá»…n phÃ­:\n\n"
        "TÃ i khoáº£n miá»…n phÃ­ Ä‘Æ°á»£c cáº¥p tá»± Ä‘á»™ng tá»« kho riÃªng,\n"
        "khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n tÃ i khoáº£n shop bÃ¡n."
    )
    if message_id:
        tg_edit_message_text(chat_id, message_id, text,
                             reply_markup=free_menu_keyboard())
    else:
        tg_send_message(chat_id, text, reply_markup=free_menu_keyboard())


def send_free_item_from_gist(chat_id, user_id, package: str, message_id=None):
    """
    Cáº¥p tÃ i khoáº£n miá»…n phÃ­ / khuyáº¿n mÃ£i cho user.
    Má»—i user chá»‰ Ä‘Æ°á»£c nháº­n 1 láº§n cho má»—i loáº¡i package.
    """
    # Náº¿u user Ä‘Ã£ nháº­n loáº¡i nÃ y rá»“i â†’ tá»« chá»‘i
    if has_claimed_free(user_id, package):
        text = (
            f"âŒ Báº¡n Ä‘Ã£ nháº­n tÃ i khoáº£n miá»…n phÃ­ / khuyáº¿n mÃ£i loáº¡i {package} trÆ°á»›c Ä‘Ã³.\n"
            "Má»—i loáº¡i tÃ i khoáº£n chá»‰ Ä‘Æ°á»£c nháº­n 1 láº§n cho má»—i ngÆ°á»i dÃ¹ng."
        )
        if message_id:
            tg_edit_message_text(chat_id, message_id, text)
        else:
            tg_send_message(chat_id, text)
        return

    # Láº¥y tÃ i khoáº£n tá»« kho
    account = get_and_consume_account(FREE_ACCOUNTS_FILE, package)
    if account:
        # ÄÃ¡nh dáº¥u Ä‘Ã£ nháº­n loáº¡i nÃ y
        mark_claimed_free(user_id, package)
        text = (
            f"ğŸ‰ ÄÃ¢y lÃ  tÃ i khoáº£n miá»…n phÃ­ {package} cá»§a báº¡n:\n\n"
            f"{account}\n\n"
            "ChÃºc báº¡n tráº£i nghiá»‡m vui váº»!"
        )
    else:
        text = (
            f"âŒ Hiá»‡n khÃ´ng cÃ²n tÃ i khoáº£n miá»…n phÃ­ {package}.\n"
            "Vui lÃ²ng thá»­ láº¡i sau hoáº·c chá»n gÃ³i khÃ¡c."
        )

    if message_id:
        tg_edit_message_text(chat_id, message_id, text)
    else:
        tg_send_message(chat_id, text)



def show_main_package(chat_id, user_id, username, package, account_type, message_id=None):
    """
    Gá»­i QR + caption + nÃºt 'TÃ´i Ä‘Ã£ chuyá»ƒn khoáº£n' vÃ  lÆ°u pending order
    """
    qr_url, amount, payment_code = generate_qr(package, account_type, user_id, username)
    type_text = "tÃ i khoáº£n shop cáº¥p" if account_type == "shop" else "tÃ i khoáº£n chÃ­nh chá»§"
    caption = (
        f"ğŸ“¦ GÃ“I MAIN {package} - {type_text}\n\n"
        "Äá»ƒ kÃ­ch hoáº¡t gÃ³i, vui lÃ²ng:\n"
        "1ï¸âƒ£ QuÃ©t mÃ£ QR nÃ y Ä‘á»ƒ thanh toÃ¡n.\n"
        "2ï¸âƒ£ Sau khi chuyá»ƒn khoáº£n, báº¥m nÃºt â€œTÃ´i Ä‘Ã£ chuyá»ƒn khoáº£nâ€ bÃªn dÆ°á»›i.\n"
        "3ï¸âƒ£ Gá»­i cho bot email tÃ i khoáº£n + ghi chÃº (náº¿u cÃ³).\n\n"
        f"ğŸ’³ Sá»‘ tiá»n cáº§n thanh toÃ¡n: {amount}Ä‘\n"
        f"ğŸ§¾ Ná»™i dung chuyá»ƒn khoáº£n (addInfo): {payment_code}\n"
        "â³ Khi há»‡ thá»‘ng xÃ¡c nháº­n thanh toÃ¡n, bot sáº½ tá»± Ä‘á»™ng cáº¥p tÃ i khoáº£n / nÃ¢ng cáº¥p gÃ³i."
    )
    tg_send_photo(
        chat_id,
        qr_url,
        caption=caption,
        reply_markup=payment_confirm_keyboard(),
    )
    USER_STATE[user_id] = {
        "awaiting_info": package,
        "account_type": account_type,
        "payment_code": payment_code,
    }
    create_pending_order(payment_code, user_id, chat_id, username, package, account_type)


# ==============================
#  ADMIN HELPERS
# ==============================
def process_paid_order(order: dict, payment_code: str,
                       order_amount: int | None = None,
                       manual: bool = False):
    """
    DÃ¹ng chung cho:
    - webhook tá»± Ä‘á»™ng (/payment_webhook)
    - lá»‡nh admin xÃ¡c nháº­n
    """
    package = order["package"]
    account_type = order["account_type"]
    username = order.get("username") or ""
    user_chat_id = order["chat_id"]
    user_id = order["user_id"]
    info = order.get("info", "")
    expected = PACKAGE_PRICES[package][account_type]
    amount = order_amount or expected

    shop_account = None
    if account_type == "shop":
        shop_account = get_and_consume_account(SHOP_ACCOUNTS_FILE, package)

    save_order_to_gist(
        user_id,
        {
            "username": username,
            "package": package,
            "account_type": account_type,
            "payment_code": payment_code,
            "amount": amount,
            "info": info,
            "account_given": shop_account,
            "status": "paid_manual" if manual else "paid",
            "paid_at": int(time.time()),
        },
    )

    orders = load_gist_json(PENDING_ORDERS_FILE)
    if payment_code in orders:
        del orders[payment_code]
        save_gist_json(PENDING_ORDERS_FILE, orders)

    if account_type == "shop":
        if shop_account:
            tg_send_message(
                user_chat_id,
                "ğŸ‰ Thanh toÃ¡n Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n!\n\n"
                f"ÄÃ¢y lÃ  tÃ i khoáº£n cá»§a báº¡n:\n{shop_account}",
            )
        else:
            tg_send_message(
                user_chat_id,
                "âš  Thanh toÃ¡n xÃ¡c nháº­n, nhÆ°ng kho tÃ i khoáº£n shop Ä‘ang háº¿t.",
            )
    else:
        tg_send_message(
            user_chat_id,
            "ğŸ‰ Thanh toÃ¡n Ä‘Ã£ xÃ¡c nháº­n!\nAdmin sáº½ nÃ¢ng cáº¥p tÃ i khoáº£n chÃ­nh chá»§ cá»§a báº¡n.",
        )

    send_admin_message(
        f"âœ” ÄÆ¡n {payment_code} Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n thá»§ cÃ´ng cho @{username}"
    )


def handle_admin_confirm(chat_id, user_id, text):
    """
    CÃ¡c lá»‡nh admin:
    /xacnhan <code>
    /xacnhan_thieu <code> <sotien_da_chuyen>
    /xacnhan_thua <code> <sotien_da_chuyen>
    /xacnhan_khong <code>
    """
    if not ADMIN_CHAT_ID or user_id != ADMIN_CHAT_ID:
        tg_send_message(chat_id, "âŒ Báº¡n khÃ´ng pháº£i ADMIN.")
        return

    parts = text.split()
    cmd = parts[0]

    # /xacnhan <payment_code>  â†’ coi nhÆ° Ä‘Ã£ thanh toÃ¡n Ä‘á»§
    if cmd == "/xacnhan":
        if len(parts) < 2:
            tg_send_message(chat_id, "DÃ¹ng: /xacnhan <payment_code>")
            return
        payment_code = parts[1]
        orders = load_gist_json(PENDING_ORDERS_FILE)
        order = orders.get(payment_code)
        if not order:
            tg_send_message(chat_id, "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.")
            return
        process_paid_order(order, payment_code, manual=True)
        return

    # /xacnhan_thieu <code> <da_chuyen>
    if cmd == "/xacnhan_thieu":
        if len(parts) < 3:
            tg_send_message(chat_id, "DÃ¹ng: /xacnhan_thieu <payment_code> <sotien_da_chuyen>")
            return
        payment_code = parts[1]
        try:
            amount = int(parts[2])
        except ValueError:
            tg_send_message(chat_id, "Sá»‘ tiá»n khÃ´ng há»£p lá»‡.")
            return
        orders = load_gist_json(PENDING_ORDERS_FILE)
        order = orders.get(payment_code)
        if not order:
            tg_send_message(chat_id, "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.")
            return
        expected = PACKAGE_PRICES[order["package"]][order["account_type"]]
        missing = expected - amount
        tg_send_message(
            order["chat_id"],
            f"Báº¡n Ä‘Ã£ chuyá»ƒn thiáº¿u {missing}Ä‘. Vui lÃ²ng chuyá»ƒn ná»‘t vá»›i ná»™i dung: {payment_code}",
        )
        send_admin_message(
            f"ÄÆ¡n {payment_code} â€“ khÃ¡ch chuyá»ƒn thiáº¿u {missing}Ä‘."
        )
        order["status"] = "underpaid"
        save_gist_json(PENDING_ORDERS_FILE, orders)
        return

    # /xacnhan_thua <code> <da_chuyen>
    if cmd == "/xacnhan_thua":
        if len(parts) < 3:
            tg_send_message(chat_id, "DÃ¹ng: /xacnhan_thua <payment_code> <sotien_da_chuyen>")
            return
        payment_code = parts[1]
        try:
            amount = int(parts[2])
        except ValueError:
            tg_send_message(chat_id, "Sá»‘ tiá»n khÃ´ng há»£p lá»‡.")
            return
        orders = load_gist_json(PENDING_ORDERS_FILE)
        order = orders.get(payment_code)
        if not order:
            tg_send_message(chat_id, "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.")
            return
        expected = PACKAGE_PRICES[order["package"]][order["account_type"]]
        over = amount - expected
        tg_send_message(
            order["chat_id"],
            f"Báº¡n Ä‘Ã£ chuyá»ƒn thá»«a {over}Ä‘. Há»‡ thá»‘ng váº«n kÃ­ch hoáº¡t gÃ³i nhÆ° bÃ¬nh thÆ°á»ng.",
        )
        send_admin_message(
            f"ÄÆ¡n {payment_code} â€“ khÃ¡ch chuyá»ƒn thá»«a {over}Ä‘."
        )
        process_paid_order(order, payment_code, order_amount=amount, manual=True)
        return

    # /xacnhan_khong <payment_code>
    if cmd == "/xacnhan_khong":
        if len(parts) < 2:
            tg_send_message(chat_id, "DÃ¹ng: /xacnhan_khong <payment_code>")
            return
        payment_code = parts[1]
        orders = load_gist_json(PENDING_ORDERS_FILE)
        order = orders.get(payment_code)
        if not order:
            tg_send_message(chat_id, "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n.")
            return
        tg_send_message(
            order["chat_id"],
            "Há»‡ thá»‘ng khÃ´ng tháº¥y giao dá»‹ch cho Ä‘Æ¡n nÃ y. Náº¿u báº¡n Ä‘Ã£ chuyá»ƒn, vui lÃ²ng liÃªn há»‡ admin.",
        )
        send_admin_message(
            f"ÄÆ¡n {payment_code} Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u KHÃ”NG THANH TOÃN."
        )
        order["status"] = "no_payment"
        save_gist_json(PENDING_ORDERS_FILE, orders)
        return


# ==============================
#  FASTAPI APP & WEBHOOK
# ==============================
app = FastAPI()


@app.post(WEBHOOK_PATH)
async def telegram_webhook(request: Request):
    try:
        update = await request.json()
        print("Incoming update:", update)
    except Exception as e:
        print("Parse update error:", e)
        return PlainTextResponse("OK")

    # 1) Callback query
    if "callback_query" in update:
        cq = update["callback_query"]
        data = cq.get("data", "")
        message = cq.get("message", {}) or {}
        chat = message.get("chat", {}) or {}
        chat_id = chat.get("id")
        message_id = message.get("message_id")
        callback_query_id = cq.get("id")

        from_user = cq.get("from", {}) or {}
        user_id = from_user.get("id")
        username = from_user.get("username") or ""

        if callback_query_id:
            tg_answer_callback_query(callback_query_id)

        if not chat_id:
            return PlainTextResponse("OK")

        if data == "buy":
            send_buy_menu(chat_id, message_id)
        elif data == "free":
            send_free_menu(chat_id, message_id)
        elif data == "back_main":
            send_main_menu(chat_id)
        elif data == "back_buy":
            send_buy_menu(chat_id, message_id)

        elif data == "buy_go_main":
            send_buy_type_menu(chat_id, "GO", message_id)
        elif data == "buy_plus_main":
            send_buy_type_menu(chat_id, "PLUS", message_id)
        elif data == "buy_team_main":
            send_buy_type_menu(chat_id, "TEAM", message_id)
        elif data == "buy_edu_main":
            send_buy_type_menu(chat_id, "EDU", message_id)

        elif data == "buy_go_shop":
            show_main_package(chat_id, user_id, username, "GO", "shop", message_id)
        elif data == "buy_go_own":
            show_main_package(chat_id, user_id, username, "GO", "own", message_id)
        elif data == "buy_plus_shop":
            show_main_package(chat_id, user_id, username, "PLUS", "shop", message_id)
        elif data == "buy_plus_own":
            show_main_package(chat_id, user_id, username, "PLUS", "own", message_id)
        elif data == "buy_team_shop":
            show_main_package(chat_id, user_id, username, "TEAM", "shop", message_id)
        elif data == "buy_team_own":
            show_main_package(chat_id, user_id, username, "TEAM", "own", message_id)
        elif data == "buy_edu_shop":
            show_main_package(chat_id, user_id, username, "EDU", "shop", message_id)

        # NÃšT "TÃ´i Ä‘Ã£ chuyá»ƒn khoáº£n"
        elif data == "confirm_paid":
            state = USER_STATE.get(user_id) or {}
            package = state.get("awaiting_info")
            account_type = state.get("account_type")
            payment_code = state.get("payment_code")

            if not (package and payment_code):
                tg_send_message(
                    chat_id,
                    "Bot khÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n cáº§n xÃ¡c nháº­n. Vui lÃ²ng dÃ¹ng /start Ä‘á»ƒ chá»n gÃ³i láº¡i.",
                )
                send_admin_message(
                    f"KhÃ¡ch @{username} (ID {user_id}) báº¥m 'TÃ´i Ä‘Ã£ chuyá»ƒn khoáº£n' nhÆ°ng khÃ´ng cÃ³ payment_code."
                )
                return PlainTextResponse("OK")

            orders = load_gist_json(PENDING_ORDERS_FILE)
            if payment_code in orders:
                orders[payment_code]["status"] = "user_confirmed"
                save_gist_json(PENDING_ORDERS_FILE, orders)

            admin_text = (
                "KHÃCH XÃC NHáº¬N ÄÃƒ CHUYá»‚N KHOáº¢N\n"
                f"User: @{username} (ID {user_id})\n"
                f"GÃ³i: {package} ({account_type})\n"
                f"MÃ£ thanh toÃ¡n: {payment_code}\n\n"
                "ğŸ‘‰ Chá»n tráº¡ng thÃ¡i sau khi kiá»ƒm tra app ngÃ¢n hÃ ng:"

            )
            send_admin_message(
                admin_text,
                reply_markup=admin_order_keyboard(payment_code),
            )

            tg_send_message(
                chat_id,
                "âœ… Cáº£m Æ¡n báº¡n! Há»‡ thá»‘ng sáº½ kiá»ƒm tra thanh toÃ¡n vÃ  cáº¥p tÃ i khoáº£n sá»›m nháº¥t.",
            )

        elif data == "free_go":
            send_free_item_from_gist(chat_id, user_id, "GO", message_id)
        elif data == "free_edu":
            send_free_item_from_gist(chat_id, user_id, "EDU", message_id)
        elif data == "free_plus":
            send_free_item_from_gist(chat_id, user_id, "PLUS", message_id)
        elif data == "free_canva_edu":
            send_free_item_from_gist(chat_id, user_id, "CANVA_EDU", message_id)

        # === NÃºt xá»­ lÃ½ Ä‘Æ¡n cho ADMIN (Äá»§ tiá»n / Thiáº¿u / Thá»«a / KhÃ´ng tháº¥y tiá»n) ===
        elif data.startswith("adm_"):
            # chá»‰ cho admin báº¥m
            if user_id != ADMIN_CHAT_ID:
                tg_send_message(chat_id, "âŒ Báº¡n khÃ´ng pháº£i ADMIN, khÃ´ng thá»ƒ thao tÃ¡c Ä‘Æ¡n.")
                return PlainTextResponse("OK")

            try:
                action, payment_code = data.split("|", 1)
            except ValueError:
                tg_send_message(chat_id, "Dá»¯ liá»‡u nÃºt khÃ´ng há»£p lá»‡.")
                return PlainTextResponse("OK")

            orders = load_gist_json(PENDING_ORDERS_FILE)
            order = orders.get(payment_code)
            if not order:
                tg_send_message(chat_id, f"KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n {payment_code}.")
                return PlainTextResponse("OK")

            customer_chat_id = order["chat_id"]
            customer_username = order.get("username") or ""
            package = order["package"]
            account_type = order["account_type"]

            # âœ… Äá»§ tiá»n â†’ xá»­ lÃ½ nhÆ° thanh toÃ¡n Ä‘á»§, cáº¥p tÃ i khoáº£n / nÃ¢ng cáº¥p
            if action == "adm_ok":
                process_paid_order(order, payment_code, manual=True)
                tg_send_message(
                    chat_id,
                    f"âœ… ÄÃ£ xÃ¡c nháº­n Äá»¦ TIá»€N cho Ä‘Æ¡n {payment_code} (user @{customer_username}).",
                )
                return PlainTextResponse("OK")

            # âš ï¸ Chuyá»ƒn thiáº¿u â†’ chá»‰ Ä‘Ã¡nh dáº¥u, nháº¯n khÃ¡ch chung chung (khÃ´ng cáº§n sá»‘ tiá»n)
            if action == "adm_under":
                order["status"] = "underpaid"
                save_gist_json(PENDING_ORDERS_FILE, orders)

                tg_send_message(
                    customer_chat_id,
                    "âš  Admin xÃ¡c nháº­n báº¡n CHUYá»‚N THIáº¾U so vá»›i sá»‘ cáº§n thanh toÃ¡n.\n"
                    "Vui lÃ²ng kiá»ƒm tra láº¡i sá»‘ tiá»n Ä‘Ã£ chuyá»ƒn vÃ  liÃªn há»‡ admin Ä‘á»ƒ Ä‘Æ°á»£c há»— trá»£.",
                )
                tg_send_message(
                    chat_id,
                    f"âš  ÄÃ£ Ä‘Ã¡nh dáº¥u Ä‘Æ¡n {payment_code} lÃ  CHUYá»‚N THIáº¾U.",
                )
                return PlainTextResponse("OK")

            # ğŸ’¸ Chuyá»ƒn thá»«a â†’ váº«n xá»­ lÃ½ nhÆ° thanh toÃ¡n Ä‘á»§ + nháº¯n khÃ¡ch lÃ  chuyá»ƒn thá»«a
            if action == "adm_over":
                process_paid_order(order, payment_code, manual=True)
                tg_send_message(
                    customer_chat_id,
                    "â„¹ Admin xÃ¡c nháº­n báº¡n CHUYá»‚N THá»ªA so vá»›i sá»‘ cáº§n thanh toÃ¡n.\n"
                    "GÃ³i váº«n Ä‘Æ°á»£c kÃ­ch hoáº¡t Ä‘áº§y Ä‘á»§, cáº£m Æ¡n báº¡n!",
                )
                tg_send_message(
                    chat_id,
                    f"ğŸ’¸ ÄÃ£ Ä‘Ã¡nh dáº¥u Ä‘Æ¡n {payment_code} lÃ  CHUYá»‚N THá»ªA & Ä‘Ã£ xá»­ lÃ½ nhÆ° thanh toÃ¡n Ä‘á»§.",
                )
                return PlainTextResponse("OK")

            # âŒ KhÃ´ng tháº¥y tiá»n â†’ Ä‘Ã¡nh dáº¥u no_payment, bÃ¡o khÃ¡ch
            if action == "adm_none":
                order["status"] = "no_payment"
                save_gist_json(PENDING_ORDERS_FILE, orders)

                tg_send_message(
                    customer_chat_id,
                    "âŒ Admin hiá»‡n *chÆ°a tháº¥y giao dá»‹ch* tÆ°Æ¡ng á»©ng vá»›i Ä‘Æ¡n cá»§a báº¡n.\n"
                    "Náº¿u báº¡n cháº¯c cháº¯n Ä‘Ã£ chuyá»ƒn, vui lÃ²ng chá»¥p mÃ n hÃ¬nh vÃ  liÃªn há»‡ admin.",
                )
                tg_send_message(
                    chat_id,
                    f"âŒ ÄÃ£ Ä‘Ã¡nh dáº¥u Ä‘Æ¡n {payment_code} lÃ  KHÃ”NG THáº¤Y TIá»€N.",
                )
                return PlainTextResponse("OK")

        return PlainTextResponse("OK")

    # 2) Message thÆ°á»ng
    message = update.get("message", {}) or {}
    if not message:
        return PlainTextResponse("OK")

    chat = message.get("chat", {}) or {}
    chat_id = chat.get("id")
    text = (message.get("text") or "").strip()
    from_user = message.get("from", {}) or {}
    user_id = from_user.get("id")
    username = from_user.get("username") or ""

    if not chat_id or not user_id:
        return PlainTextResponse("OK")

    # Lá»†NH ADMIN
    if text.startswith(("/xacnhan", "/xacnhan_thieu", "/xacnhan_thua", "/xacnhan_khong")):
        handle_admin_confirm(chat_id, user_id, text)
        return PlainTextResponse("OK")

    if text.startswith("/start"):
        save_user_to_gist(user_id)
        send_main_menu(chat_id)
        return PlainTextResponse("OK")

    state = USER_STATE.get(user_id) or {}
    package = state.get("awaiting_info")
    account_type = state.get("account_type")
    payment_code = state.get("payment_code")

    if package and payment_code:
        info = text
        update_pending_order_info(payment_code, info)

        send_admin_message(
            f"KHÃCH Gá»¬I THÃ”NG TIN\n"
            f"User: @{username} (ID {user_id})\n"
            f"GÃ³i: {package} ({account_type})\n"
            f"MÃ£ thanh toÃ¡n: {payment_code}\n"
            f"ThÃ´ng tin:\n{info}"
        )

        tg_send_message(
            chat_id,
            "âœ… ÄÃ£ nháº­n thÃ´ng tin cá»§a báº¡n. Sau khi thanh toÃ¡n Ä‘Æ°á»£c xÃ¡c nháº­n, bot sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ vÃ  cáº¥p tÃ i khoáº£n.",
        )
        return PlainTextResponse("OK")

    tg_send_message(
        chat_id,
        "â„¹ï¸ Vui lÃ²ng dÃ¹ng /start Ä‘á»ƒ má»Ÿ menu vÃ  chá»n gÃ³i.",
    )
    return PlainTextResponse("OK")


@app.post("/payment_webhook")
async def payment_webhook(request: Request):
    """
    Webhook Ä‘á»ƒ há»‡ thá»‘ng thanh toÃ¡n gá»i vÃ o khi giao dá»‹ch thÃ nh cÃ´ng.
    Body JSON vÃ­ dá»¥:
    {
        "code": "GO-shop-username",
        "amount": 50000
    }
    """
    try:
        data = await request.json()
    except Exception:
        return {"ok": False, "error": "invalid_json"}

    payment_code = data.get("code")
    amount = data.get("amount")

    if not payment_code:
        return {"ok": False, "error": "missing_code"}

    orders = load_gist_json(PENDING_ORDERS_FILE)
    order = orders.get(payment_code)
    if not order:
        return {"ok": False, "error": "order_not_found"}

    package = order["package"]
    account_type = order["account_type"]
    user_id = order["user_id"]
    chat_id = order["chat_id"]
    username = order.get("username", "")
    info = order.get("info", "")

    expected_amount = PACKAGE_PRICES[package][account_type]

    if amount is None:
        return {"ok": False, "error": "missing_amount", "expected": expected_amount}

    if amount < expected_amount:
        diff = expected_amount - amount
        orders[payment_code]["status"] = "underpaid"
        orders[payment_code]["amount"] = amount
        save_gist_json(PENDING_ORDERS_FILE, orders)

        send_admin_message(
            f"KHÃCH CHUYá»‚N THIáº¾U TIá»€N\n"
            f"User: @{username} (ID {user_id})\n"
            f"GÃ³i: {package} ({account_type})\n"
            f"MÃ£: {payment_code}\n"
            f"ÄÃ£ chuyá»ƒn: {amount}Ä‘ / Cáº§n: {expected_amount}Ä‘\n"
            f"Thiáº¿u: {diff}Ä‘"
        )

        tg_send_message(
            chat_id,
            "âš  Thanh toÃ¡n chÆ°a Ä‘á»§ sá»‘ tiá»n cáº§n thiáº¿t!\n"
            f"Báº¡n Ä‘Ã£ chuyá»ƒn: {amount}Ä‘ â€“ cáº§n: {expected_amount}Ä‘.\n"
            f"Thiáº¿u: {diff}Ä‘.\n"
            "Vui lÃ²ng chuyá»ƒn ná»‘t pháº§n cÃ²n thiáº¿u.",
        )
        return {"ok": True, "status": "underpaid"}

    # Ä‘á»§ hoáº·c thá»«a
    shop_account = None
    if account_type == "shop":
        shop_account = get_and_consume_account(SHOP_ACCOUNTS_FILE, package)

    final_status = "paid_exact" if amount == expected_amount else "paid_over"

    save_order_to_gist(
        user_id,
        {
            "username": username,
            "package": package,
            "account_type": account_type,
            "info": info,
            "account_given": shop_account,
            "payment_code": payment_code,
            "amount": amount,
            "status": final_status,
            "paid_at": int(time.time()),
        },
    )

    try:
        del orders[payment_code]
        save_gist_json(PENDING_ORDERS_FILE, orders)
    except Exception as e:
        print("remove pending error:", e)

    over_note = ""
    if amount > expected_amount:
        diff = amount - expected_amount
        over_note = f"\nKhÃ¡ch chuyá»ƒn thá»«a {diff}Ä‘."

    send_admin_message(
        f"THANH TOÃN THÃ€NH CÃ”NG\n"
        f"User: @{username} (ID {user_id})\n"
        f"GÃ³i: {package} ({account_type})\n"
        f"MÃ£ thanh toÃ¡n: {payment_code}\n"
        f"Sá»‘ tiá»n: {amount}Ä‘ (yÃªu cáº§u: {expected_amount}Ä‘)\n"
        f"ThÃ´ng tin: {info or '(khÃ´ng cÃ³)'}\n"
        f"TÃ i khoáº£n shop cáº¥p: {shop_account or '(khÃ´ng cÃ³)'}"
        f"{over_note}"
    )

    if account_type == "shop":
        if shop_account:
            user_msg = (
                "âœ… Há»‡ thá»‘ng Ä‘Ã£ xÃ¡c nháº­n thanh toÃ¡n thÃ nh cÃ´ng.\n\n"
                f"ÄÃ¢y lÃ  tÃ i khoáº£n shop cáº¥p cá»§a báº¡n:\n{shop_account}"
            )
        else:
            user_msg = (
                "âœ… Há»‡ thá»‘ng Ä‘Ã£ xÃ¡c nháº­n thanh toÃ¡n thÃ nh cÃ´ng.\n"
                "Hiá»‡n kho tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c cáº­p nháº­t, admin sáº½ cáº¥p tÃ i khoáº£n cho báº¡n sá»›m nháº¥t."
            )
    else:
        user_msg = (
            "âœ… Há»‡ thá»‘ng Ä‘Ã£ xÃ¡c nháº­n thanh toÃ¡n thÃ nh cÃ´ng.\n"
            "Admin sáº½ tiáº¿n hÃ nh nÃ¢ng cáº¥p / thiáº¿t láº­p gÃ³i cho tÃ i khoáº£n chÃ­nh chá»§ cá»§a báº¡n."
        )

    if amount > expected_amount:
        diff = amount - expected_amount
        user_msg += f"\n\nâ„¹ Há»‡ thá»‘ng ghi nháº­n báº¡n Ä‘Ã£ chuyá»ƒn thá»«a {diff}Ä‘."

    tg_send_message(chat_id, user_msg)
    return {"ok": True, "status": final_status}


@app.get("/")
def home():
    return {
        "status": "running",
        "webhook_path": WEBHOOK_PATH,
        "webhook_url": WEBHOOK_URL,
    }
